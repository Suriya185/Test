name: test
on:
  push:
  workflow_dispatch:
    inputs:
      ENVIRONMENT:
        type: string
        default: production
permissions:
  id-token: write
  contents: write
  checks: write
  packages: write

jobs:
   deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 

    - name: print
      shell: bash
      run: |
        JSON_Content='[{
                          "index": 0,
                          "name": "AzureMonitor",
                          "orgId": 1,
                          "url": "/api/datasources/proxy/2",
                          "isDefault": true,
                          "subscriptionId": "parameters.subscriptionId",
                          "tenantId": "db329bd8-af39-4039-b008-3360eebd6898",
                          "logAnalyticsWorkspace": "TFO_LOG_ANALYTICS_WORKSPACE_ID",
                          "appInsightsAppId": "TFO_APP_INSIGHTS_APPLICATION_ID",
                          "appInsightsApiKey": "TFO_APP_INSIGHTS_API_KEY_GRAFANA",
                          "clientId": "e6ed32be-39b8-4eaa-bffc-d5433e6e0b7e",
                          "clientSecret": "parameters.grafanaClientSecret"
                        },
                        {
                          "index": 1,
                          "name": "lz-ehd-dev-paconnect",
                          "orgId": 1,
                          "isDefault": false,
                          "subscriptionId": "245841fd-f2fa-4aa8-b222-835928d953c8",
                          "tenantId": "bd16c2b9-cbc8-46b6-892e-36bbe902b867",
                          "logAnalyticsWorkspace": "dev-clint-app-insights-ws",
                          "appInsightsAppId": "fb630410-9934-4587-bea8-e794ab446121",
                          "appInsightsApiKey": "appInsightsApiKey_dev_paconnect",
                          "clientId": "fffbb760-e78c-47c3-9d60-8cb8c90e470c",
                          "clientSecret": "grafanaClientSecret_paconnect"
                        },
                        {
                          "index": 2,
                          "name": "lz-ehd-stg-paconnect",
                          "orgId": 1,
                          "isDefault": false,
                          "subscriptionId": "300b6a09-1534-444f-998f-3b2dc298b393",
                          "tenantId": "bd16c2b9-cbc8-46b6-892e-36bbe902b867",
                          "logAnalyticsWorkspace": "stg-clint-app-insights-ws",
                          "appInsightsAppId": "4a5a3050-a43c-42c4-99c3-a18995b94cd2",
                          "appInsightsApiKey": "appInsightsApiKey_stg_paconnect",
                          "clientId": "fffbb760-e78c-47c3-9d60-8cb8c90e470c",
                          "clientSecret": "grafanaClientSecret_paconnect"
                        }]'
                items=$(echo "$JSON_Content" | jq -c -r '.[]')
                my_variable=""
                newline='
                        '
                for item in  ${items[@]}; do
                  keys=$(echo $item | jq -c 'keys[]')
                   for key in $keys; do
                      value=$(echo $item | jq -r .$key)
                      index=$(echo $item | jq -r .index)
                     if [[ $my_variable == "" ]];
                      then
                         my_variable="grafana.azure[$index].$key: $value"
                      else
                         my_variable="${my_variable}\ngrafana.azure[$index].$key: $value"
                      fi
                    done
                 done
                echo "GRAFANA_CONFIG_B64=$(echo "$my_variable" | tr -d '"')" >> $GITHUB_ENV
                string_no_quotes=$(echo "$my_variable" | tr -d '"')
                echo "$GRAFANA_CONFIG_B64" 

